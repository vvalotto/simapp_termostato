# Sync README.md to Confluence
# Este workflow sincroniza el README.md con una página de Confluence
# cada vez que se hace push a main con cambios en el README.

name: Sync README to Confluence

on:
  push:
    branches:
      - main
    paths:
      - 'README.md'
  workflow_dispatch:  # Permite ejecución manual

jobs:
  sync-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install markdown

      - name: Convert Markdown to Confluence format and sync
        env:
          CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          CONFLUENCE_PAGE_ID: ${{ secrets.CONFLUENCE_PAGE_ID }}
        run: |
          # Convertir Markdown a HTML
          python << 'EOF'
          import markdown
          import json

          with open('README.md', 'r', encoding='utf-8') as f:
              md_content = f.read()

          # Convertir a HTML con extensiones útiles
          html = markdown.markdown(md_content, extensions=['tables', 'fenced_code', 'toc'])

          # Envolver en macro de Confluence para mejor renderizado
          confluence_content = f'''<ac:structured-macro ac:name="html">
            <ac:plain-text-body><![CDATA[
              <style>
                pre {{ background-color: #f4f5f7; padding: 12px; border-radius: 3px; overflow-x: auto; }}
                code {{ background-color: #f4f5f7; padding: 2px 4px; border-radius: 3px; font-family: monospace; }}
                table {{ border-collapse: collapse; width: 100%; }}
                th, td {{ border: 1px solid #dfe1e6; padding: 8px; text-align: left; }}
                th {{ background-color: #f4f5f7; }}
              </style>
              {html}
            ]]></ac:plain-text-body>
          </ac:structured-macro>'''

          # Guardar para el siguiente paso
          with open('/tmp/confluence_content.txt', 'w', encoding='utf-8') as f:
              f.write(confluence_content)
          EOF

      - name: Get current page version
        id: get_version
        env:
          CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          CONFLUENCE_PAGE_ID: ${{ secrets.CONFLUENCE_PAGE_ID }}
        run: |
          VERSION=$(curl -s -u "${CONFLUENCE_EMAIL}:${CONFLUENCE_API_TOKEN}" \
            "${CONFLUENCE_URL}/wiki/rest/api/content/${CONFLUENCE_PAGE_ID}?expand=version" \
            | jq -r '.version.number')
          echo "Current version: ${VERSION}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Update Confluence page
        env:
          CONFLUENCE_URL: ${{ secrets.CONFLUENCE_URL }}
          CONFLUENCE_EMAIL: ${{ secrets.CONFLUENCE_EMAIL }}
          CONFLUENCE_API_TOKEN: ${{ secrets.CONFLUENCE_API_TOKEN }}
          CONFLUENCE_PAGE_ID: ${{ secrets.CONFLUENCE_PAGE_ID }}
        run: |
          # Leer contenido convertido
          CONTENT=$(cat /tmp/confluence_content.txt)

          # Incrementar versión
          NEW_VERSION=$((${{ steps.get_version.outputs.version }} + 1))

          # Crear payload JSON
          jq -n \
            --arg title "Simuladores Termostato Home" \
            --arg content "$CONTENT" \
            --argjson version "$NEW_VERSION" \
            '{
              "version": {"number": $version},
              "title": $title,
              "type": "page",
              "body": {
                "storage": {
                  "value": $content,
                  "representation": "storage"
                }
              }
            }' > /tmp/payload.json

          # Actualizar página
          HTTP_CODE=$(curl -s -o /tmp/response.json -w "%{http_code}" \
            -X PUT \
            -u "${CONFLUENCE_EMAIL}:${CONFLUENCE_API_TOKEN}" \
            -H "Content-Type: application/json" \
            "${CONFLUENCE_URL}/wiki/rest/api/content/${CONFLUENCE_PAGE_ID}" \
            -d @/tmp/payload.json)

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ Página actualizada exitosamente (versión ${NEW_VERSION})"
          else
            echo "❌ Error al actualizar página. HTTP Code: ${HTTP_CODE}"
            cat /tmp/response.json
            exit 1
          fi
